---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
setwd("C://Users/Owner/Desktop/Project-Howler/R-mpa")
```

```{r}
###libraries
# devtools::install_github("jbengler/tidyheatmaps")
library(tidyverse)
library(dplyr)
library(ggplot2)
library(tidyheatmaps)
library(reshape2)
library(RColorBrewer)
library(vegan)
library(FactoMineR)
library(pheatmap)
library(viridis)
library(tidyheatmaps)



```

```{r}
# read the data- these are filtered  and saved by"mpa-leve-filtering" notebook
species <- read.table('new-filtered_species.txt', header=TRUE, sep='\t')
species
genus <- read.table("new-filtered_genus.txt" , header = TRUE , sep = '\t')
genus
```

```{r}
### to normalize the data 

#relative abundances

# Store genus names
genus_names <- genus[,1]

# Convert the numerical data to matrix for normalization
numerical_data <- as.matrix(genus[,-1])  # exclude first column but keep it stored

# Normalize
normalized_data <- sweep(numerical_data, 2, colSums(numerical_data), '/')
normalized_data <- normalized_data * 100

# Create final dataframe with genus names
final_genus <- data.frame(Genus=genus_names, normalized_data)
colnames(final_genus) <- gsub("\\.", "-", colnames(final_genus))
# write.table(final_genus , "final_genus.txt", sep = "\t" , row.names = FALSE, quote = FALSE)

final_genus

```
```{r}
# Store genus names
species_names <- species[,1]

# Convert the numerical data to matrix for normalization
numerical_data <- as.matrix(species[,-1])  # exclude first column but keep it stored

# Normalize
normalized_data <- sweep(numerical_data, 2, colSums(numerical_data), '/')
normalized_data <- normalized_data * 100

# Create final dataframe with genus names
final_species <- data.frame(Species=species_names, normalized_data)


colnames(final_species) <- gsub("\\.", "-", colnames(final_species))
write.table(final_species , "final_species.txt", sep = "\t" , row.names = FALSE, quote = FALSE)

final_species

```
```{r}

genus_data <- read.table("final_genus.txt" , header = TRUE , sep = '\t')
colnames(genus_data) <- gsub("\\.", "-", colnames(genus_data))


metadata <- read.csv("howlermeta.csv")  # Replace with your actual file name
genus_data
metadata


```



```{r}

##clean and merge


genus_long <- genus_data %>%
  pivot_longer(cols = -Genus, names_to = "SampleID", values_to = "Abundance")
genus_long

# Merge with metadata
tidy_data <- merge(genus_long, metadata, by="SampleID")


tidy_data


```

```{r}
#### overall abundance patherns


# Calculate mean abundance per genus across all samples
mean_abundance <- tidy_data %>%
  group_by(Genus) %>%
  summarize(mean_abundance = mean(Abundance)) %>%
  arrange(desc(mean_abundance)) %>%
  head(10)  # Top 10 most abundant genera

# Create a bar plot of top 10 most abundant genera
p1 <- ggplot(mean_abundance, aes(x = reorder(Genus, mean_abundance), y = mean_abundance)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  theme_minimal() +
  labs(title = "Top 10 Most Abundant Genera",
       x = "Genus",
       y = "Mean Relative Abundance (%)")

# Calculate abundance patterns across seasons for top 5 genera
top5_genera <- mean_abundance$Genus[1:5]
seasonal_patterns <- tidy_data %>%
  filter(Genus %in% top5_genera) %>%
  group_by(Season, Genus) %>%
  summarize(mean_abundance = mean(Abundance),
            se = sd(Abundance)/sqrt(n())) %>%
  ungroup()

# Create a faceted box plot for seasonal patterns
p2 <- 
  ggplot(tidy_data %>% filter(Genus %in% top5_genera), 
       aes(x = Season, y = Abundance, fill = Season)) +
  geom_boxplot() +
  scale_fill_brewer(palette = "Dark2") +
  facet_wrap(~Genus, scales = "free_y") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Seasonal Distribution of Top 5 Most Abundant Genera",
       y = "Relative Abundance (%)")

# Print summary statistics
print("Summary of top 5 genera abundance by season:")
seasonal_summary <- tidy_data %>%
  filter(Genus %in% top5_genera) %>%
  group_by(Season, Genus) %>%
  summarize(
    mean_abundance = mean(Abundance),
    sd_abundance = sd(Abundance),
    median_abundance = median(Abundance)
  )

p1
p2
# ggsave("Top 10 Most Abundant Genera.jpg", plot = p1, width = 6, height = 4, dpi = 300)
# ggsave("Seasonal Distribution of Top 5 Most Abundant Genera.jpg", plot = p2, width = 6, height = 4, dpi = 300)




```
```{r}
###top10

top10_genera <- mean_abundance$Genus[1:10]
seasonal_patterns <- tidy_data %>%
  filter(Genus %in% top10_genera) %>%
  group_by(Season, Genus) %>%
  summarize(mean_abundance = mean(Abundance),
            se = sd(Abundance)/sqrt(n())) %>%
  ungroup()

top10_genera

```
```{r}

```


```{r}
# Filter for top 10 genera
top10_genera <- mean_abundance$Genus[1:10]
filtered_data <- tidy_data %>%
  filter(Genus %in% top10_genera)

# Create a pivot table for the heatmap
heatmap_data <- filtered_data %>%
  select(SampleID, Genus, Abundance) %>%
  spread(key = Genus, value = Abundance, fill = 0) %>%
  column_to_rownames(var = "SampleID")

# Replace NA values with 0
heatmap_data[is.na(heatmap_data)] <- 0

# Transpose the heatmap data
heatmap_data <- t(heatmap_data)

# Load metadata for annotations
metadata <- read.csv("howlermeta.csv")

# Ensure metadata columns match the SampleID in heatmap_data
metadata <- metadata %>%
  filter(SampleID %in% colnames(heatmap_data))

# Prepare annotation data
annotation_data <- metadata %>%
  select(SampleID, Season, Individual) %>%
  column_to_rownames(var = "SampleID")

# Convert Season and Individual to factors
annotation_data$Season <- as.factor(annotation_data$Season)
annotation_data$Individual <- as.factor(annotation_data$Individual)

annotation_colors <- list(
  Season = c("Dry" = "brown", "Intermediate" = "yellow", "Rain" = "blue"),
  Individual = c("Dos" = "red", "Hugo" = "purple", "Isa" = "brown", "Jupiler" = "pink", "Melanie" = "orange", "Maia" = "green", "Uno" = "cyan")
)

# Create the heatmap with annotations
p1 <- pheatmap(
  heatmap_data,
  annotation_col = annotation_data,  # Use annotation_col for x-axis annotations
  annotation_colors = annotation_colors,
  color = viridis::magma(10),  # Ensure the color palette is correctly specified
  border_color = "black",
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  show_rownames = TRUE,
  show_colnames = TRUE,
  main = "Heatmap of Top 10 Most Abundant Genera"
)
p1
ggsave("Heatmap of Top 10 Most Abundant Genera.jpg", plot = p1, width = 10, height = 8, dpi = 300)


```

```{r}



```


```{r}

library(tibble)

# Retry transforming data to wide format
wide_data <- tidy_data %>%
  select(SampleID, Genus, Abundance) %>%
  pivot_wider(names_from = Genus, values_from = Abundance, values_fill = 0) %>%
  column_to_rownames(var = "SampleID")

# Calculate Bray-Curtis dissimilarity matrix
bray_curtis_matrix <- vegdist(wide_data, method = "bray")

# Convert to regular matrix and display first few rows/columns
bc_matrix <- as.matrix(bray_curtis_matrix)

# Save the full matrix to a file
# write.csv(as.matrix(bray_curtis_matrix), "bray_curtis_matrix.csv")

```



```{r}


# Perform PCoA using the Bray-Curtis dissimilarity matrix
# bray_curtis_matrix <- bray_curtis_matrix[,-1]
pcoa_result <- cmdscale(bc_matrix, eig = TRUE, k = 2)

# Create a dataframe for plotting
pcoa_df <- data.frame(
  PCoA1 = pcoa_result$points[,1],
  PCoA2 = pcoa_result$points[,2],
  Season = metadata$Season,
  Individual = metadata$Individual
)

pcoa_points <- data.frame(
  SampleID = rownames(wide_data),
  PCo1 = pcoa_result$points[,1],
  PCo2 = pcoa_result$points[,2]
)

# Calculate variance explained
variance_explained <- round(100 * pcoa_result$eig / sum(pcoa_result$eig), 2)

# Merge with metadata
pcoa_data <- merge(pcoa_points, metadata, by="SampleID")

# Plot PCoA results by Season
p1 <- ggplot(pcoa_df, aes(x = PCoA1, y = PCoA2, color = Season)) +
  geom_point(size = 3, alpha = 0.6) +
  theme_minimal() +
  labs(
    title = "PCoA of Gut Microbiome Composition by Season",
    x = "PCoA1",
    y = "PCoA2"
  ) +
  stat_ellipse(level = 0.95)

# Plot PCoA results by Individual
p2 <- ggplot(pcoa_df, aes(x = PCoA1, y = PCoA2, color = Individual)) +
  geom_point(size = 3, alpha = 0.6) +
  theme_minimal() +
  labs(
    title = "PCoA of Gut Microbiome Composition by Individual",
    x = "PCoA1",
    y = "PCoA2"
  )

# Print plots
print(p1)
print(p2)

ggsave("PCoA of Gut Microbiome Composition by Season.jpg", plot = p1, width = 6, height = 4, dpi = 300)
ggsave("PCoA of Gut Microbiome Composition by Individual.jpg", plot = p2, width = 6, height = 4, dpi = 300)


```


```{r}

# Correct the order of months starting from October
month_levels <- c("October", "November", "December", "January", "February", "March", "April", "May", "June", "July", "August", "September")

# Ensure Month is a factor with the correct levels
pcoa_data$Month <- factor(pcoa_data$Month, levels = month_levels)

# Recreate the plot with simplified months
p_temporal_clean <- ggplot(pcoa_data, aes(x=Month, y=PCo1, color=Individual, group=Individual)) +
  geom_line(linewidth=1, alpha=0.7) +
  geom_point(size=3) +
  theme_bw() +
  labs(x="", 
       y="PCo1",
       title="Temporal Changes in Gut Microbiome Composition") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.minor = element_blank(),
        panel.spacing = unit(2, "lines"),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12)) +
  facet_wrap(~Individual, scales="free_y", ncol=2)

# Print the plot
print(p_temporal_clean)

# Calculate monthly statistics for each individual
monthly_stats <- aggregate(PCo1 ~ Month + Individual, data=pcoa_data,
                         FUN=function(x) c(mean=mean(x), sd=sd(x), n=length(x)))

# Convert the results to a more readable format
monthly_stats_df <- data.frame(
  Month = monthly_stats$Month,
  Individual = monthly_stats$Individual,
  Mean_PCo1 = monthly_stats$PCo1[,1],
  SD_PCo1 = monthly_stats$PCo1[,2],
  N_samples = monthly_stats$PCo1[,3]
)

print("Monthly statistics by individual:")
print(monthly_stats_df)

# Save the plot



ggsave("Temporal_changes_genus_monthly.pdf", plot = p_temporal_clean, width = 8, height = 12)


```
```{r}
cat("## Analysis of Temporal Dynamics\n")
cat("Most individuals show distinct shifts between seasons\n
The largest changes appear to occur between winter (January-February) and spring (March-April) months.\n
grouped data by individual and time, then viz changes in Bray-Curtis distances or PCoA coordinates over time\n\n"
)

cat("Isa shows the most dramatic fluctuations across months\n
Jupiler maintains relatively more stable composition across the year\n
Maia has fewer samples but shows similar patterns to others")
```




```{r}
set.seed(123) # for reproducibility

# Run PERMANOVA for each factor
permanova_season <- adonis2(bray_curtis_matrix ~ Season, data = metadata, permutations = 999)
permanova_sex <- adonis2(bray_curtis_matrix ~ Sex, data = metadata, permutations = 999)
permanova_individual <- adonis2(bray_curtis_matrix ~ Individual, data = metadata, permutations = 999)

# Print results
print("PERMANOVA results for Season:")
print(permanova_season)
print("\
PERMANOVA results for Sex:")
print(permanova_sex)
print("\
PERMANOVA results for Individual:")
print(permanova_individual)

# Create a data frame with the R-squared values and p-values from PERMANOVA
permanova_results <- data.frame(
    Factor = c("Season", "Individual", "Sex"),
    R2 = c(0.03139 , 0.13165, 0.04976),
    P_value = c(0.154, 0.005, 0.002)
)

# Create a bar plot using ggplot2
library(ggplot2)

# Create the plot
p <- ggplot(permanova_results, aes(x = reorder(Factor, R2), y = R2)) +
    geom_bar(stat = "identity", fill = ifelse(permanova_results$P_value < 0.05, "steelblue", "gray")) +
    geom_text(aes(label = sprintf("R\u00b2 = %.3f\
p = %.3f", R2, P_value)), 
              vjust = -0.5, size = 4) +
    theme_minimal() +
    labs(title = "PERMANOVA Results: Variance Explained by Each Factor",
         x = "Factor",
         y = "R\u00b2 (Variance Explained)") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          plot.title = element_text(hjust = 0.5)) +
    ylim(0, max(permanova_results$R2) * 1.2)  # Add some space for the labels

# Save the plot
ggsave("permanova_results.png", p, width = 10, height = 6, dpi = 300)

# Display the plot
print(p)

```

```{r}
#PERMANOVA

# Extract R-squared values for Season and Individual
set.seed(123)
season_r2 <- adonis2(bray_curtis_matrix ~ Season, data = metadata, permutations = 999)$R2[1]
individual_r2 <- adonis2(bray_curtis_matrix ~ Individual, data = metadata,  permutations = 999)$R2[1]
sex_r2 <- adonis2(bray_curtis_matrix ~ Sex, data = metadata,  permutations = 999)$R2[1]




# Create a comparison data frame
comparison_df <- data.frame(
  Variable = c("Season", "Individual", "Sex"),
  R2 = c(season_r2, individual_r2, sex_r2)
)


### bar plot comparing the two factors
p1 <-
  ggplot(comparison_df, aes(x = Variable, y = R2, fill = Variable)) +
  geom_bar(stat = "identity", width = 0.6) +
  theme_minimal() +
  labs(
    title = "Comparison of Variance Explained",
    y = "R-squared (proportion of variance explained)",
    x = ""
  ) +
  scale_fill_manual(values = c("Season" = "#E69F00", "Individual" = "#56B4E9")) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"
  ) +
  geom_text(aes(label = sprintf("%.1f%%", R2 * 100)), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5)

p1
ggsave("PERMANOVA.jpg", plot = p1, width = 6, height = 4, dpi = 300)

```

```{r}
###let's explore core genera for each individual, present in at least 50% of samples




```

